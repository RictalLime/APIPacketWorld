<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.HistorialDeEnvioMapper">

    <resultMap id="mapaHistorial" type="pojo.HistorialDeEnvio">
        <id property="idHistorialDeEnvio" column="idHistorialDeEnvio" />
        <result property="noGuia" column="noGuia" />
        <result property="idColaborador" column="idColaborador" />
        <result property="colaborador" column="nombreColaborador" /> 
        <result property="idEstadoDeEnvio" column="idEstadoDeEnvio" />
        <result property="nombreEstado" column="nombreEstado" /> <!-- Importante para la vista -->
        <result property="motivo" column="motivo" />
        <result property="tiempoDeCambio" column="tiempoDeCambio" />
    </resultMap>

    <!-- Insertar nuevo movimiento -->
    <insert id="registrarCambioEstatus" parameterType="pojo.HistorialDeEnvio">
        INSERT INTO historialDeEnvio 
            (idEstadoDeEnvio, idColaborador, noGuia, motivo, tiempoDeCambio)
        VALUES 
            (#{idEstadoDeEnvio}, #{idColaborador}, #{noGuia}, #{motivo}, NOW())
    </insert>

    <!-- Obtener historial por GuÃ­a (Usado en el Rastreo) -->
    <select id="obtenerHistorialPorEnvio" resultMap="mapaHistorial" parameterType="String">
        SELECT 
            h.idHistorialDeEnvio,
            h.noGuia,
            h.idColaborador,
            -- Opcional: Si tienes tabla colaborador, haz JOIN para sacar el nombre
            -- c.nombre as nombreColaborador, 
            h.idEstadoDeEnvio,
            IFNULL(e.nombre, 'Estado Desconocido') AS nombreEstado,
            h.motivo,
            DATE_FORMAT(h.tiempoDeCambio, '%Y-%m-%d %H:%i:%s') AS tiempoDeCambio
        FROM historialDeEnvio h
        LEFT JOIN estadoDeEnvio e ON h.idEstadoDeEnvio = e.idEstadoDeEnvio
        WHERE h.noGuia = #{noGuia}
        ORDER BY h.tiempoDeCambio DESC
    </select>

</mapper>