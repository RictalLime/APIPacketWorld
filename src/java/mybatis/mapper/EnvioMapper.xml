<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.EnvioMapper">

    <!-- ResultMap: Puente entre Base de Datos y Java -->
    <resultMap id="mapaEnvio" type="pojo.Envio">
        <!-- IDs -->
        <id property="idEnvio" column="idEnvio" />
        <result property="noGuia" column="noGuia" />
        
        <!-- Relaciones -->
        <result property="idCliente" column="idCliente" />
        <result property="cliente" column="cliente" /> <!-- Nombre concatenado -->
        <result property="idColaborador" column="idColaborador" />
        <result property="colaborador" column="colaborador" /> <!-- Nombre concatenado -->
        <result property="idSucursal" column="idSucursal" />
        <result property="costoDeEnvio" column="costoDeEnvio" />
        
        <!-- Estado del Envío -->
        <result property="idEstadoDeEnvio" column="idEstadoDeEnvio" />
        <!-- CORRECCIÓN: En Envio.java se llama 'estadoDeEnvio', no 'estatus' -->
        <result property="estadoDeEnvio" column="nombreEstado" /> 

        <!-- ORIGEN -->
        <result property="origenCalle" column="origenCalle" />
        <result property="origenNumero" column="origenNumero" />
        <result property="origenColonia" column="origenColonia" />
        <result property="origenCodigoPostal" column="origenCodigoPostal" />
        <result property="idOrigenCiudad" column="idOrigenCiudad" />
        <result property="idOrigenEstado" column="idOrigenEstado" />
        <!-- Nombres Texto -->
        <result property="nombreCiudadOrigen" column="nombreCiudadOrigen" />
        <result property="nombreEstadoOrigen" column="nombreEstadoOrigen" />
        <result property="origen" column="origen" /> <!-- Concatenado -->

        <!-- DESTINO -->
        <result property="destinoCalle" column="destinoCalle" />
        <result property="destinoNumero" column="destinoNumero" />
        <result property="destinoColonia" column="destinoColonia" />
        <result property="destinoCodigoPostal" column="destinoCodigoPostal" />
        <result property="idDestinoCiudad" column="idDestinoCiudad" />
        <result property="idDestinoEstado" column="idDestinoEstado" />
        <!-- Nombres Texto -->
        <result property="nombreCiudadDestino" column="nombreCiudadDestino" />
        <result property="nombreEstadoDestino" column="nombreEstadoDestino" />
        <result property="destino" column="destino" /> <!-- Concatenado -->
    </resultMap>

    <!-- Bloque SQL Reutilizable -->
    <sql id="selectEnvioFields">
        SELECT 
            e.idEnvio,
            e.idCliente,
            e.idSucursal,
            IFNULL(CONCAT(c.nombre, ' ', c.apellidoPaterno), 'Cliente') AS cliente,

            -- Ubicación Origen
            e.idOrigenCiudad, e.idOrigenEstado,
            e.origenCalle, e.origenNumero, e.origenColonia, e.origenCodigoPostal,
            cio.nombre AS nombreCiudadOrigen,
            eso.nombre AS nombreEstadoOrigen,
            -- Concatenamos dirección completa para mostrar fácil en la web
            CONCAT(e.origenCalle, ' ', e.origenNumero, ', ', e.origenColonia, ', ', cio.nombre) AS origen,

            -- Ubicación Destino
            e.idDestinoCiudad, e.idDestinoEstado,
            e.destinoCalle, e.destinoNumero, e.destinoColonia, e.destinoCodigoPostal,
            cid.nombre AS nombreCiudadDestino,
            esd.nombre AS nombreEstadoDestino,
            CONCAT(e.destinoCalle, ' ', e.destinoNumero, ', ', e.destinoColonia, ', ', cid.nombre) AS destino,

            -- Datos Generales
            e.noGuia,
            e.costoDeEnvio,
            e.idEstadoDeEnvio,
            IFNULL(est.nombre, 'Estado Desconocido') AS nombreEstado, -- Alias coincide con ResultMap

            e.idColaborador,
            IFNULL(CONCAT(col.nombre, ' ', col.apellidoPaterno), 'Sin Conductor') AS colaborador

        FROM envio e
        LEFT JOIN cliente c ON e.idCliente = c.idCliente
        LEFT JOIN estadoDeEnvio est ON e.idEstadoDeEnvio = est.idEstadoDeEnvio
        LEFT JOIN colaborador col ON e.idColaborador = col.idColaborador
        -- Joins de Origen
        LEFT JOIN ciudad cio ON e.idOrigenCiudad = cio.idCiudad
        LEFT JOIN estado eso ON e.idOrigenEstado = eso.idEstado
        -- Joins de Destino
        LEFT JOIN ciudad cid ON e.idDestinoCiudad = cid.idCiudad
        LEFT JOIN estado esd ON e.idDestinoEstado = esd.idEstado
    </sql>

    <!-- Consultas de Lectura -->

    <select id="getObtenerEnvios" resultMap="mapaEnvio">
        <include refid="selectEnvioFields"/>
    </select>

    <select id="getObtenerEnviosConductor" resultMap="mapaEnvio" parameterType="int">
        <include refid="selectEnvioFields"/>
        WHERE e.idColaborador = #{idColaborador}
    </select>

    <select id="getObtenerEnviosPorNoGuia" resultMap="mapaEnvio" parameterType="String">
        <include refid="selectEnvioFields"/>
        WHERE e.noGuia = #{noGuia}
    </select>

    <select id="getObtenerEstadosDeEnvio" resultType="pojo.EstadoDeEnvio">
        SELECT idEstadoDeEnvio, nombre FROM estadoDeEnvio
    </select>

    <!-- Operaciones de Escritura (CRUD) -->

    <insert id="registrar" parameterType="pojo.Envio">
        INSERT INTO envio (
            idCliente, idSucursal, idColaborador, noGuia, costoDeEnvio, idEstadoDeEnvio,
            origenCalle, origenNumero, origenColonia, origenCodigoPostal, idOrigenCiudad, idOrigenEstado,
            destinoCalle, destinoNumero, destinoColonia, destinoCodigoPostal, idDestinoCiudad, idDestinoEstado
        ) VALUES (
            #{idCliente}, #{idSucursal}, #{idColaborador}, #{noGuia}, #{costoDeEnvio}, #{idEstadoDeEnvio},
            #{origenCalle}, #{origenNumero}, #{origenColonia}, #{origenCodigoPostal}, #{idOrigenCiudad}, #{idOrigenEstado},
            #{destinoCalle}, #{destinoNumero}, #{destinoColonia}, #{destinoCodigoPostal}, #{idDestinoCiudad}, #{idDestinoEstado}
        )
    </insert>

    <update id="editar" parameterType="pojo.Envio">
        UPDATE envio SET
            idCliente = #{idCliente},
            idSucursal = #{idSucursal},
            idColaborador = #{idColaborador},
            costoDeEnvio = #{costoDeEnvio},
            idEstadoDeEnvio = #{idEstadoDeEnvio},
            -- Origen
            origenCalle = #{origenCalle}, origenNumero = #{origenNumero}, origenColonia = #{origenColonia},
            origenCodigoPostal = #{origenCodigoPostal}, idOrigenCiudad = #{idOrigenCiudad}, idOrigenEstado = #{idOrigenEstado},
            -- Destino
            destinoCalle = #{destinoCalle}, destinoNumero = #{destinoNumero}, destinoColonia = #{destinoColonia},
            destinoCodigoPostal = #{destinoCodigoPostal}, idDestinoCiudad = #{idDestinoCiudad}, idDestinoEstado = #{idDestinoEstado}
        WHERE idEnvio = #{idEnvio}
    </update>

    <update id="actualizarEstado" parameterType="pojo.Envio">
        UPDATE envio SET idEstadoDeEnvio = #{idEstadoDeEnvio} WHERE idEnvio = #{idEnvio}
    </update>

    <delete id="eliminar" parameterType="int">
        DELETE FROM envio WHERE idEnvio = #{idEnvio}
    </delete>

</mapper>